<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AIRV — Advanced Intelligence Remote Viewing</title>
<style>
  :root{
    --bg:#0b0f0c; --panel:#0f1511; --line:#18201a; --term:#0a120d;
    --green:#10e08a; --green-dim:#66f1bb; --amber:#ffc857; --red:#ff4d4d; --gray:#a2a9a6;
    --txt:#e6fff3; --muted:#b7d6c9;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Cascadia Code", "Fira Code", Consolas, "Liberation Mono", "DejaVu Sans Mono", monospace;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--txt);font:14px/1.4 var(--mono);
  }
  .container{max-width:1200px;margin:0 auto;padding:16px}
  .grid{display:grid;gap:12px}
  .g2{grid-template-columns: 1fr 1fr}
  .g3{grid-template-columns: 1fr 1fr 1fr}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:8px;padding:12px}
  .title{font-size:18px;margin:0 0 8px 0;color:var(--green)}
  .btn{background:transparent;border:1px solid var(--green);color:var(--green);padding:8px 10px;border-radius:6px;cursor:pointer}
  .btn:hover{background:rgba(16,224,138,0.08)}
  .btn.red{border-color:var(--red);color:var(--red)}
  .btn.amber{border-color:var(--amber);color:var(--amber)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted)}
  input,select,textarea{
    background:var(--term);border:1px solid var(--line);color:var(--txt);border-radius:6px;padding:8px;font:14px var(--mono);
  }
  textarea{width:100%;min-height:90px;resize:vertical}
  .kbd{display:inline-block;border:1px solid var(--line);background:#0a130e;color:var(--green-dim);padding:2px 6px;border-radius:4px;font-size:12px}
  .badge{display:inline-block;border:1px solid var(--line);padding:2px 6px;border-radius:999px;font-size:12px;background:#0a130e;color:var(--muted)}
  .term{background:var(--term);border:1px solid var(--line);border-radius:8px;padding:10px;min-height:140px;white-space:pre-wrap}
  .ok{color:var(--green)} .warn{color:var(--amber)} .err{color:var(--red)}
  .bar{height:6px;background:#122018;border-radius:4px;overflow:hidden;border:1px solid var(--line)}
  .bar>i{display:block;height:100%;background:linear-gradient(90deg, rgba(16,224,138,0.6), rgba(16,224,138,0.9));width:0%}
  canvas.sk{width:100%;max-width:100%;background:#0b140f;border:1px dashed #1a2a21;border-radius:6px;touch-action:none}
  .blur{filter:blur(8px)}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:50}
  .overlay .box{background:var(--panel);border:1px solid var(--line);border-radius:8px;padding:16px;max-width:560px;width:95%}
  .boot{position:fixed;inset:0;background:linear-gradient(#040604,#0b0f0c);display:flex;align-items:center;justify-content:center}
  .boot .crt{width:90%;max-width:900px;background:#06110b;border:1px solid #0a1f14;border-radius:8px;padding:16px;color:#74f0c8;min-height:260px}
  .link{color:var(--green);text-decoration:none;border-bottom:1px dotted var(--green)}
  .top{position:sticky;top:0;background:linear-gradient(180deg, rgba(11,15,12,.98), rgba(11,15,12,.86));padding:8px;border-bottom:1px solid var(--line);z-index:10}
  .top .big{font-size:20px;color:var(--green)}
  .right{margin-left:auto}
  .hl{color:var(--amber)}
  .divider{border-top:1px dashed #1a2a21;margin:8px 0}
  .small{font-size:12px}
  .center{text-align:center}
  .hidden{display:none}
</style>
</head>
<body>

<!-- BOOT -->
<div id="boot" class="boot">
  <div class="crt term" id="bootLog"></div>
</div>

<div id="app" class="hidden">
  <div class="top row">
    <div class="big">AIRV ▲ Advanced Intelligence Remote Viewing <span class="badge">CLASSIFIED // TRAINING</span></div>
    <div class="right row">
      <span class="small muted">Lang:</span>
      <select id="langSel">
        <option value="bg" selected>BG</option>
        <option value="en">EN</option>
      </select>
      <button class="btn" id="focusBtn" title="Toggle Focus (F)">Focus</button>
      <button class="btn" id="helpBtn" title="Help (?)">?</button>
      <button class="btn amber" id="settingsBtn" title="Settings">Settings</button>
    </div>
  </div>

  <div class="container grid g3">
    <!-- LEFT NAV / STATUS -->
    <div class="panel">
      <h3 class="title">OPS // Status</h3>
      <div class="row small">
        <span class="muted">Viewer:</span><input id="viewer" placeholder="RV-001" style="width:120px"/>
        <span class="muted">Clearance:</span><select id="clearance"><option>Level 3</option><option>Level 2</option><option>Level 1</option></select>
      </div>
      <div class="divider"></div>
      <div class="row small"><span class="muted">TRN:</span><span id="trn" class="kbd">—</span><button class="btn" id="genTRN">Gen</button></div>
      <div class="row small"><span class="muted">Blind:</span>
        <select id="blind"><option value="true" selected>ON</option><option value="false">OFF</option></select>
        <span class="muted">Deck:</span><select id="deckSel"><option value="sample">Sample</option><option value="custom">Custom</option></select>
        <input type="file" id="deckFile" accept="application/json" class="hidden"/>
        <button class="btn" id="loadDeck">Load</button>
      </div>
      <div class="divider"></div>
      <div class="row small"><span class="muted">Stage:</span><span id="stageName" class="kbd">—</span><span class="muted">Round:</span><span id="round" class="kbd">0</span></div>
      <div class="bar" title="Stage Progress"><i id="stageBar"></i></div>
      <div class="row small"><span class="muted">Time:</span><span id="timer" class="kbd">00:00</span><span class="muted">AOL:</span><span id="aolCount" class="kbd">0</span></div>
      <div class="divider"></div>
      <div class="row"><button class="btn" id="newTask">New Task</button><button class="btn" id="loadTask">Load Task</button><button class="btn" id="saveTask">Save Task</button></div>
      <div class="row"><button class="btn amber" id="exportSessions">Export Sessions</button><button class="btn" id="importSessions">Import</button><input id="importFile" type="file" accept="application/json" class="hidden"/></div>
      <p class="small muted">Hotkeys: <span class="kbd">F</span> Focus • <span class="kbd">N</span> Next • <span class="kbd">A</span> AOL • <span class="kbd">?</span> Help</p>
    </div>

    <!-- CENTER: STAGE VIEW -->
    <div class="panel" id="stagePanel">
      <h3 class="title" id="stageTitle">Mission Console</h3>
      <div id="stageBody" class="grid"></div>
    </div>

    <!-- RIGHT: INTEL LOG -->
    <div class="panel">
      <h3 class="title">INTEL // Log</h3>
      <div id="log" class="term"></div>
      <div class="divider"></div>
      <button class="btn red" id="resetSession">Reset Session</button>
    </div>
  </div>
</div>

<!-- AOL BREAK OVERLAY -->
<div id="aolOverlay" class="overlay">
  <div class="box">
    <h3 class="title">AOL BREAK</h3>
    <p class="muted small" id="aolMsg">Drop analysis. Breathe. Reset mind.</p>
    <div class="center" style="margin:10px 0">
      <div class="kbd" id="aolTimer">20</div>
    </div>
    <button class="btn" id="endAOL">Resume</button>
  </div>
</div>

<!-- SETTINGS -->
<div id="settingsOverlay" class="overlay">
  <div class="box">
    <h3 class="title">Settings</h3>
    <div class="grid g2">
      <div class="panel">
        <div class="small muted">Stage durations (seconds)</div>
        <div class="row small">
          <label class="muted" style="width:60px">S1</label><input id="tS1" type="number" value="90" style="width:100px"/>
        </div>
        <div class="row small">
          <label class="muted" style="width:60px">S2</label><input id="tS2" type="number" value="180" style="width:100px"/>
        </div>
        <div class="row small">
          <label class="muted" style="width:60px">S3</label><input id="tS3" type="number" value="180" style="width:100px"/>
        </div>
        <div class="row small">
          <label class="muted" style="width:60px">S4</label><input id="tS4" type="number" value="180" style="width:100px"/>
        </div>
        <div class="row small">
          <label class="muted" style="width:60px">S5</label><input id="tS5" type="number" value="150" style="width:100px"/>
        </div>
        <div class="row small">
          <label class="muted" style="width:60px">S6</label><input id="tS6" type="number" value="180" style="width:100px"/>
        </div>
        <div class="divider"></div>
        <label class="row small"><input id="sounds" type="checkbox"/> <span class="muted">Enable sounds</span></label>
        <label class="row small"><input id="hardMode" type="checkbox"/> <span class="muted">Compliance mode (lock times)</span></label>
      </div>
      <div class="panel">
        <div class="small muted">UI</div>
        <label class="row small"><input id="bigFonts" type="checkbox" checked/> <span class="muted">Large fonts</span></label>
        <label class="row small"><input id="showHints" type="checkbox" /> <span class="muted">Show brief hints per stage</span></label>
        <div class="divider"></div>
        <button class="btn" id="closeSettings">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- HELP -->
<div id="helpOverlay" class="overlay">
  <div class="box">
    <h3 class="title">AIRV // Help</h3>
    <div class="term small">
[CTRL] Flow:
S1 Ideogram (I/A/B, gestalt)  →  S2 Sensory  →  S3 Sketch/Move
→  S4 Matrix (S,D,AI,AOL)  →  S5 Interrogate  →  S6 Model  →  Feedback

Hotkeys:  N Next  •  A AOL Break  •  F Focus  •  ? Help
    </div>
    <button class="btn" id="closeHelp">Close</button>
  </div>
</div>

<script>
/** ===================== Boot ===================== **/
const bootLines = [
  "[AIRV BOOT] Initializing classified training kernel...",
  "[SECURITY] Clearance profiles... OK",
  "[RV PROTOCOL] Loading CRV stages S1–S6...",
  "[RV PROTOCOL] AOL / AOL-BREAK handlers... OK",
  "[TASKING] TRN generator online...",
  "[STORAGE] Local vault ready...",
  "[IO] JSON import/export... OK",
  "[READY] Press ENTER to enter AIRV SYSTEM"
];
(function boot(){
  const log = document.getElementById('bootLog');
  let i=0; const tick=()=>{ if(i<bootLines.length){ log.textContent += bootLines[i++] + "\\n"; setTimeout(tick, 350);} }
  tick();
  window.addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){ document.getElementById('boot').style.display='none'; document.getElementById('app').classList.remove('hidden'); init(); }
  });
})();

/** ===================== State ===================== **/
const S = {
  lang:'bg', focus:false, showHints:false, sounds:false, hard:false, bigFonts:true,
  viewer:'RV-001', clearance:'Level 3',
  deckType:'sample', deck:[],
  tasks:[], sessions:[],
  blind:true, trn:'', round:0, stage:'', stageStart:0, stageDur:0, aolCount:0,
  // data structures for stages
  s1:{i:'',a:'',b:'',gestalts:[],aol:[],png:null},
  s2:{tokens:[]},
  s3:{moves:[],png:null},
  s4:{S:'',D:'',AI:'',AOLS:''},
  s5:{func:'',purpose:'',context:'',summary:''},
  s6:{top:null,side:null,scale:''},
  fb:{revealed:false,target:null,self:3,autoPct:0}
};
const sampleDeck = [
  {id:"LGT", label:"Lighthouse on sea cliff", tags:["structure","water","wind","light","rock","tall","cylindrical"]},
  {id:"BRG", label:"Suspension bridge", tags:["structure","metal","water","span","cables","traffic"]},
  {id:"VOL", label:"Volcano with plume", tags:["mountain","smoke","heat","ash","cone","energy"]},
  {id:"CAT", label:"Gothic cathedral interior", tags:["structure","stone","arches","echo","cool","dim","religious"]},
  {id:"OIL", label:"Offshore oil platform", tags:["structure","metal","water","smell","oil","machinery","noise","wind"]},
  {id:"WAT", label:"Tall waterfall", tags:["water","spray","sound","cliff","mist","cool","rock"]},
  {id:"STD", label:"Open-air stadium", tags:["structure","oval","crowd","noise","grass","open","lights"]},
  {id:"GLC", label:"Glacier valley", tags:["ice","cold","blue","crevasse","slow","mountain","silence"]}
];

/** ===================== Utils ===================== **/
const $ = sel=>document.querySelector(sel);
const log = (msg, cls='') => { const l = document.getElementById('log'); l.innerHTML += (cls?`<span class="${cls}">`:'')+ msg + (cls?'</span>':'') + "\\n"; l.scrollTop = l.scrollHeight; }
const pad = n => String(n).padStart(2,'0');
const now = () => Math.floor(Date.now()/1000);
const genTRN = ()=> String(Math.floor(10000000+Math.random()*90000000));
function startStage(key, seconds){
  S.stage = key; S.stageStart = now(); S.stageDur = seconds||0;
  updateTop();
  if(S.stageDur>0) requestAnimationFrame(tick);
  renderStage();
}
function tick(){
  const used = Math.min(now()-S.stageStart, S.stageDur);
  const pct = Math.round( (used/S.stageDur)*100 ); $('#stageBar').style.width = pct+'%';
  const left = Math.max(0, S.stageDur - used);
  $('#timer').textContent = `${pad(Math.floor(left/60))}:${pad(left%60)}`;
  if(left>0 && S.stageDur>0) requestAnimationFrame(tick);
}
function clearStageData(){
  S.s1={i:'',a:'',b:'',gestalts:[],aol:[],png:null};
  S.s2={tokens:[]};
  S.s3={moves:[],png:null};
  S.s4={S:'',D:'',AI:'',AOLS:''};
  S.s5={func:'',purpose:'',context:'',summary:''};
  S.s6={top:null,side:null,scale:''};
  S.fb={revealed:false,target:null,self:3,autoPct:0};
}
function autoMatch(tokens, tags){
  const T = new Set(tokens.map(x=>x.toLowerCase()));
  const G = new Set((tags||[]).map(x=>x.toLowerCase()));
  let hit=0; G.forEach(g=>{ if(T.has(g)) hit++; });
  return Math.round( (hit / Math.max(G.size,1)) * 100 );
}
function saveSession(){
  const rec = {
    ts:new Date().toISOString(), viewer:S.viewer, trn:S.trn, blind:S.blind,
    s1:S.s1, s2:S.s2, s3:S.s3, s4:S.s4, s5:S.s5, s6:S.s6, fb:S.fb
  };
  S.sessions.push(rec); localStorage.setItem('airv_sessions', JSON.stringify(S.sessions));
  return rec;
}

/** ===================== Canvas ===================== **/
function attachSketchCanvas(id, onSave){
  const cvs = document.getElementById(id); const ctx = cvs.getContext('2d');
  let drawing=false, last=null; ctx.lineWidth=2; ctx.strokeStyle='#8ef6c5'; ctx.lineCap='round';
  const get = e=>{ const r=cvs.getBoundingClientRect(); const t=e.touches?e.touches[0]:e; return {x:t.clientX-r.left, y:t.clientY-r.top};}
  const draw = p=>{ if(!last){ last=p; return; } ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; }
  const down = e=>{ drawing=true; last=null; draw(get(e)); }
  const move = e=>{ if(drawing) draw(get(e));}
  const up   = ()=>{ drawing=false; onSave && onSave(cvs.toDataURL('image/png')); }
  cvs.addEventListener('mousedown',down); cvs.addEventListener('mousemove',move); window.addEventListener('mouseup',up);
  cvs.addEventListener('touchstart',down,{passive:false}); cvs.addEventListener('touchmove',e=>{e.preventDefault();move(e)},{passive:false}); cvs.addEventListener('touchend',up);
  return { clear(){ ctx.clearRect(0,0,cvs.width,cvs.height); onSave && onSave(null); } };
}

/** ===================== Stage Renderers ===================== **/
function renderStage(){
  const body = document.getElementById('stageBody');
  const tl = k=>({bg:{ // minimal i18n (основни подсказки)
    s1:"S1 — Идеограма: 2s жест, после I/A/B и гесталти. Ако се появи „име“, натисни AOL Break.",
    s2:"S2 — Сензорика: изброявай цветове, текстури, температура, звуци, миризми, вкусове, „размерни“.",
    s3:"S3 — Скица & Move: по-голяма скица; move: ↑, вътре, ←, →, назад, +време.",
    s4:"S4 — Матрица: S (сензорика), D (размерни), AI (емоц. импакт), AOL/AOL‑S (анализ).",
    s5:"S5 — Интерогиране: функция/цел/контекст; резюме без „имена“.",
    s6:"S6 — Модел: горен/страничен изглед, мащаб, връзки.",
    fb:"Feedback: reveal, auto‑match %, self‑score (0–7), export."
  }, en:{
    s1:"S1 — Ideogram: 2s capture, then I/A/B and gestalts. If a 'name' appears → AOL Break.",
    s2:"S2 — Sensory: list colors, textures, temps, sounds, smells, tastes, dimensionals.",
    s3:"S3 — Sketch & Move: larger sketch; move: up, inside, left, right, back, time +1h.",
    s4:"S4 — Matrix: S (sensory), D (dimensional), AI (aesthetic), AOL/AOL‑S (analysis).",
    s5:"S5 — Interrogate: function/purpose/context; short summary (no naming).",
    s6:"S6 — Model: top/side views, scale, relations.",
    fb:"Feedback: reveal, auto‑match %, self‑score (0–7), export."
  }})[S.lang][k];
  const hint = S.showHints ? (key)=>`<p class="small muted">${tl(key)}</p>` : (_)=>'';

  if(S.stage==='s1'){
    document.getElementById('stageTitle').textContent = "S1 // Ideogram";
    body.innerHTML = `
      ${hint('s1')}
      <div class="grid g2">
        <div>
          <div class="row"><button class="btn" id="cap2s">2s capture</button><button class="btn" id="clr1">Clear</button></div>
          <canvas id="c1" class="sk" width="900" height="240"></canvas>
        </div>
        <div>
          <div class="row">
            <div><div class="small muted">I</div><input id="s1i" placeholder="curve/angle/loop"/></div>
            <div><div class="small muted">A</div><input id="s1a" placeholder="push/pull/fast/slow"/></div>
            <div><div class="small muted">B</div><input id="s1b" placeholder="land/water/structure…"/></div>
          </div>
          <div class="divider"></div>
          <div class="small muted">Gestalts</div>
          <div id="gests" class="row small"></div>
          <div class="divider"></div>
          <div class="row"><input id="s1aol" placeholder="AOL note…" style="flex:1"/><button class="btn" id="addAOL">Add AOL</button><button class="btn red" id="aolBreak">AOL Break</button></div>
          <ul id="aolList" class="small"></ul>
          <div class="divider"></div>
          <button class="btn amber" id="next">Next (S2)</button>
        </div>
      </div>`;
    const gest = ["land","water","structure","biological","energy","motion"];
    const gWrap = document.getElementById('gests');
    gWrap.innerHTML = gest.map(g=>`<label><input type="checkbox" value="${g}"/> <span class="badge">${g}</span></label>`).join(' ');
    [...gWrap.querySelectorAll('input')].forEach(ch=> ch.onchange = ()=> {
      if(ch.checked) S.s1.gestalts.push(ch.value); else S.s1.gestalts = S.s1.gestalts.filter(x=>x!==ch.value);
    });
    const c = attachSketchCanvas('c1', png=>S.s1.png=png);
    document.getElementById('clr1').onclick = ()=> c.clear();
    const canvas = document.getElementById('c1');
    let timer=null;
    document.getElementById('cap2s').onclick = ()=>{
      canvas.style.pointerEvents='auto'; canvas.classList.remove('blur');
      if(timer) clearTimeout(timer);
      timer = setTimeout(()=>{ canvas.style.pointerEvents='none'; canvas.classList.add('blur'); }, 2000);
    };
    canvas.style.pointerEvents='none'; canvas.classList.add('blur');
    document.getElementById('s1i').oninput=e=>S.s1.i=e.target.value;
    document.getElementById('s1a').oninput=e=>S.s1.a=e.target.value;
    document.getElementById('s1b').oninput=e=>S.s1.b=e.target.value;
    const aolList = document.getElementById('aolList');
    const renderAOL = ()=> aolList.innerHTML = S.s1.aol.map(x=>`<li>${x}</li>`).join('');
    renderAOL();
    document.getElementById('addAOL').onclick = ()=>{ const v=document.getElementById('s1aol').value.trim(); if(v){ S.s1.aol.push(v); S.aolCount++; renderAOL(); $('#s1aol').value=''; updateTop(); log("[AOL] "+v, "warn"); } }
    document.getElementById('aolBreak').onclick = aolBreak;
    document.getElementById('next').onclick = ()=> startStage('s2', getDur('S2'));
  }
  else if(S.stage==='s2'){
    document.getElementById('stageTitle').textContent = "S2 // Sensory";
    body.innerHTML = `
      ${hint('s2')}
      <div class="grid g2">
        <div>
          <div class="small muted">Tokens</div>
          <div id="tokWrap" class="row"></div>
          <div class="row"><input id="tok" placeholder="blue / cold / rough …" style="flex:1"/><button class="btn" id="addTok">Add</button></div>
        </div>
        <div>
          <div class="small muted">Tips</div>
          <div class="term small">colors, textures, temps, sounds, smells, tastes, dimensionals</div>
          <button class="btn amber" id="next">Next (S3)</button>
        </div>
      </div>`;
    const draw = ()=> $('#tokWrap').innerHTML = S.s2.tokens.map(x=>`<span class="badge">${x}</span>`).join(' ');
    draw();
    $('#addTok').onclick = ()=>{ const v=$('#tok').value.trim(); if(v){ S.s2.tokens.push(v); $('#tok').value=''; draw(); } };
    $('#next').onclick = ()=> startStage('s3', getDur('S3'));
  }
  else if(S.stage==='s3'){
    document.getElementById('stageTitle').textContent = "S3 // Sketch & Move";
    body.innerHTML = `
      ${hint('s3')}
      <div class="grid g2">
        <div>
          <div class="row"><button class="btn" id="clr3">Clear</button></div>
          <canvas id="c3" class="sk" width="1000" height="380"></canvas>
        </div>
        <div>
          <div class="small muted">Move</div>
          <div class="row">
            <select id="mv">
              <option>10 m above</option><option>inside</option><option>10 m left</option>
              <option>10 m right</option><option>10 m back</option><option>+1 hour</option>
            </select>
            <button class="btn" id="doMove">Execute</button>
          </div>
          <div class="divider"></div>
          <div class="small muted">Log</div>
          <div id="mvlog" class="term small"></div>
          <button class="btn amber" id="next">Next (S4)</button>
        </div>
      </div>`;
    const c = attachSketchCanvas('c3', png=>S.s3.png=png);
    $('#clr3').onclick = ()=> c.clear();
    const rlog = ()=> $('#mvlog').textContent = S.s3.moves.map(x=>`• ${x}`).join("\\n");
    $('#doMove').onclick = ()=>{ const v=$('#mv').value; S.s3.moves.push(v); rlog(); log("[MOVE] "+v,"muted"); };
    rlog();
    $('#next').onclick = ()=> startStage('s4', getDur('S4'));
  }
  else if(S.stage==='s4'){
    document.getElementById('stageTitle').textContent = "S4 // Matrix";
    body.innerHTML = `
      ${hint('s4')}
      <div class="grid g2">
        <div>
          <div class="small muted">S — sensory</div><textarea id="s4s">${S.s4.S||''}</textarea>
          <div class="small muted">D — dimensional</div><textarea id="s4d">${S.s4.D||''}</textarea>
        </div>
        <div>
          <div class="small muted">AI — aesthetic impact</div><textarea id="s4ai">${S.s4.AI||''}</textarea>
          <div class="small muted">AOL / AOL‑S</div><textarea id="s4a">${S.s4.AOLS||''}</textarea>
          <div class="row"><button class="btn red" id="aolBreak">AOL Break</button><button class="btn amber" id="next">Next (S5)</button></div>
        </div>
      </div>`;
    $('#s4s').oninput=e=>S.s4.S=e.target.value;
    $('#s4d').oninput=e=>S.s4.D=e.target.value;
    $('#s4ai').oninput=e=>S.s4.AI=e.target.value;
    $('#s4a').oninput=e=>S.s4.AOLS=e.target.value;
    $('#aolBreak').onclick=aolBreak;
    $('#next').onclick = ()=> startStage('s5', getDur('S5'));
  }
  else if(S.stage==='s5'){
    document.getElementById('stageTitle').textContent = "S5 // Interrogation";
    body.innerHTML = `
      ${hint('s5')}
      <div class="grid g2">
        <div>
          <div class="small muted">Function</div><textarea id="s5f">${S.s5.func||''}</textarea>
          <div class="small muted">Purpose</div><textarea id="s5p">${S.s5.purpose||''}</textarea>
        </div>
        <div>
          <div class="small muted">Context</div><textarea id="s5c">${S.s5.context||''}</textarea>
          <div class="small muted">Summary (no names)</div><textarea id="s5s">${S.s5.summary||''}</textarea>
          <div class="row"><button class="btn red" id="aolBreak">AOL Break</button><button class="btn amber" id="next">Next (S6)</button></div>
        </div>
      </div>`;
    $('#s5f').oninput=e=>S.s5.func=e.target.value;
    $('#s5p').oninput=e=>S.s5.purpose=e.target.value;
    $('#s5c').oninput=e=>S.s5.context=e.target.value;
    $('#s5s').oninput=e=>S.s5.summary=e.target.value;
    $('#aolBreak').onclick=aolBreak;
    $('#next').onclick = ()=> startStage('s6', getDur('S6'));
  }
  else if(S.stage==='s6'){
    document.getElementById('stageTitle').textContent = "S6 // Model";
    body.innerHTML = `
      ${hint('s6')}
      <div class="grid g2">
        <div>
          <div class="row"><button class="btn" id="clrTop">Clear</button></div>
          <canvas id="top" class="sk" width="900" height="260"></canvas>
        </div>
        <div>
          <div class="row"><button class="btn" id="clrSide">Clear</button></div>
          <canvas id="side" class="sk" width="900" height="260"></canvas>
          <div class="small muted">Scale / notes</div><textarea id="scaleN">${S.s6.scale||''}</textarea>
          <div class="row"><button class="btn amber" id="toFB">Feedback</button></div>
        </div>
      </div>`;
    const t = attachSketchCanvas('top', png=>S.s6.top=png);
    const s = attachSketchCanvas('side',png=>S.s6.side=png);
    $('#clrTop').onclick=()=>t.clear(); $('#clrSide').onclick=()=>s.clear();
    $('#scaleN').oninput=e=>S.s6.scale=e.target.value;
    $('#toFB').onclick = ()=> startStage('fb', 0);
  }
  else if(S.stage==='fb'){
    document.getElementById('stageTitle').textContent = "INTEL // Feedback";
    if(!S.fb.target){
      const pool = S.deck.length? S.deck : sampleDeck;
      S.fb.target = pool[Math.floor(Math.random()*pool.length)];
    }
    const tokensAll = [
      ...S.s2.tokens,
      ...(S.s4.S||'').split(/[,\s]+/).filter(Boolean),
      ...(S.s4.D||'').split(/[,\s]+/).filter(Boolean),
      ...(S.s4.AI||'').split(/[,\s]+/).filter(Boolean)
    ];
    S.fb.autoPct = autoMatch(tokensAll, S.fb.target.tags||[]);
    body.innerHTML = `
      ${hint('fb')}
      <div class="grid g2">
        <div>
          <button class="btn" id="reveal">Reveal</button>
          <div id="tgt" class="${S.blind && !S.fb.revealed ? 'blur':''}" style="margin-top:8px">
            <div class="small muted">Target</div>
            <div>${S.fb.target.label}</div>
            <div class="small muted">Tags</div>
            <div>${(S.fb.target.tags||[]).map(x=>`<span class="badge">${x}</span>`).join(' ')}</div>
          </div>
        </div>
        <div>
          <div class="small muted">Self‑score (0–7)</div>
          <input id="self" type="range" min="0" max="7" step="1" value="${S.fb.self}"/>
          <div class="small">Auto‑match: <span class="ok">${S.fb.autoPct}%</span></div>
          <div class="divider"></div>
          <div class="row">
            <button class="btn amber" id="export">Export JSON</button>
            <button class="btn" id="newSession">New Session</button>
          </div>
        </div>
      </div>`;
    $('#reveal').onclick=()=>{ S.fb.revealed=true; renderStage(); };
    $('#self').oninput=e=>S.fb.self=Number(e.target.value);
    $('#export').onclick=()=>{
      const rec = saveSession();
      const blob = new Blob([JSON.stringify(rec,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`airv-${S.trn}.json`; a.click();
      log("[EXPORT] session saved","ok");
    };
    $('#newSession').onclick = ()=>{
      S.round++; S.trn = genTRN(); clearStageData(); updateTop();
      startStage('s1', getDur('S1'));
    };
  }
}
function getDur(k){
  const v = {S1:+$('#tS1').value, S2:+$('#tS2').value, S3:+$('#tS3').value, S4:+$('#tS4').value, S5:+$('#tS5').value, S6:+$('#tS6').value}[k];
  return S.hard ? v : 0; // ако не е hard, не заключваме време
}
function updateTop(){
  $('#viewer').value = S.viewer;
  $('#trn').textContent = S.trn || '—';
  $('#stageName').textContent = S.stage || '—';
  $('#round').textContent = String(S.round);
  $('#aolCount').textContent = String(S.aolCount);
}

/** ===================== AOL Break ===================== **/
function aolBreak(){
  S.aolCount++; updateTop();
  const ov = $('#aolOverlay'); ov.style.display='flex';
  let t=20; const tm = $('#aolTimer'); tm.textContent=t;
  const iv=setInterval(()=>{ t--; tm.textContent=t; if(t<=0){ clearInterval(iv);} },1000);
  $('#endAOL').onclick = ()=>{ clearInterval(iv); ov.style.display='none'; log("[AOL BREAK] reset","warn"); };
}

/** ===================== Init & Events ===================== **/
function init(){
  // load local
  S.sessions = JSON.parse(localStorage.getItem('airv_sessions')||'[]');
  S.tasks = JSON.parse(localStorage.getItem('airv_tasks')||'[]');
  S.deck = []; S.deckType='sample';
  S.trn = genTRN(); S.round=1;
  updateTop(); renderStageWelcome();

  // controls
  $('#genTRN').onclick=()=>{ S.trn=genTRN(); updateTop(); log("[TRN] "+S.trn,"ok"); };
  $('#deckSel').onchange=e=> S.deckType=e.target.value;
  $('#loadDeck').onclick=()=>{ if(S.deckType==='custom') $('#deckFile').click(); else { S.deck=sampleDeck; log("[DECK] sample loaded","muted"); } };
  $('#deckFile').onchange=(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ S.deck=JSON.parse(r.result); log("[DECK] custom loaded","ok"); }catch(_){ log("[DECK] invalid JSON","err"); } }; r.readAsText(f); };

  $('#viewer').oninput=e=>S.viewer=e.target.value;
  $('#blind').onchange=e=>S.blind = (e.target.value==='true');
  $('#focusBtn').onclick=()=>{ S.focus=!S.focus; document.body.style.fontSize = S.focus? '16px':'14px'; log(S.focus?"[FOCUS] on":"[FOCUS] off","muted"); };
  $('#helpBtn').onclick=()=> $('#helpOverlay').style.display='flex';
  $('#closeHelp').onclick=()=> $('#helpOverlay').style.display='none';
  $('#settingsBtn').onclick=()=> $('#settingsOverlay').style.display='flex';
  $('#closeSettings').onclick=()=> { $('#settingsOverlay').style.display='none'; applySettings(); }
  $('#bigFonts').onchange=e=>{ document.body.style.fontSize = e.target.checked? '16px':'14px'; }
  $('#showHints').onchange=e=> S.showHints = e.target.checked;
  $('#sounds').onchange=e=> S.sounds = e.target.checked;
  $('#hardMode').onchange=e=> S.hard = e.target.checked;

  $('#newTask').onclick=makeTask;
  $('#loadTask').onclick=loadTask;
  $('#saveTask').onclick=saveTask;
  $('#exportSessions').onclick=()=>{ const blob=new Blob([JSON.stringify(S.sessions,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='airv-sessions.json'; a.click(); }
  $('#importSessions').onclick=()=>$('#importFile').click();
  $('#importFile').onchange=e=>{ const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=()=>{ try{ const arr=JSON.parse(r.result); if(Array.isArray(arr)){ S.sessions=arr; localStorage.setItem('airv_sessions',JSON.stringify(S.sessions)); log("[IMPORT] sessions loaded","ok"); } }catch(_){ log("[IMPORT] invalid JSON","err"); } }; r.readAsText(f); };
  $('#resetSession').onclick=()=>{ clearStageData(); S.round=1; S.trn=genTRN(); S.aolCount=0; updateTop(); renderStageWelcome(); log("[RESET] session cleared","warn"); }

  // hotkeys
  window.addEventListener('keydown',(e)=>{
    if(e.key==='?'){ $('#helpOverlay').style.display='flex'; }
    if(e.key==='f' || e.key==='F'){ $('#focusBtn').click(); }
    if(e.key==='n' || e.key==='N'){ if(S.stage) nextStage(); }
    if(e.key==='a' || e.key==='A'){ aolBreak(); }
  });

  applySettings();
}
function applySettings(){
  document.body.style.fontSize = $('#bigFonts').checked? '16px':'14px';
  S.showHints = $('#showHints').checked;
  S.sounds = $('#sounds').checked;
  S.hard = $('#hardMode').checked;
}
function renderStageWelcome(){
  $('#stageTitle').textContent="Mission Console";
  $('#stageBody').innerHTML = `
    <div class="term">
[AIRV] This console follows CRV stages S1–S6 (DIA/Army manuals). Use TRN; run blind; declare AOL; proceed by stages.
→ Press <N> or click "Begin S1" to start.

References: CRV Stages I–VI, AOL/AOL‑Break, S4 Matrix (DIA 1985–1986).  (see docs)
    </div>
    <div class="row"><button class="btn amber" id="begin">Begin S1</button></div>`;
  $('#begin').onclick=()=> startStage('s1', getDur('S1'));
}
function nextStage(){
  const order = ['s1','s2','s3','s4','s5','s6','fb'];
  const i = order.indexOf(S.stage);
  if(i>=0 && i<order.length-1) startStage(order[i+1], getDur(order[i+1].toUpperCase()));
}

/** ===================== Tasking (по задание) ===================== **/
function makeTask(){
  const cue = prompt("Enter short task cue (optional, keep viewer blind):","");
  const tags = prompt("Enter tags (comma separated), e.g. structure,water,wind:","");
  const t = { trn: genTRN(), cue: cue||"", tags: tags? tags.split(',').map(s=>s.trim()).filter(Boolean):[] };
  S.tasks.push(t); localStorage.setItem('airv_tasks', JSON.stringify(S.tasks));
  S.trn = t.trn; updateTop();
  log("[TASK] created TRN "+t.trn,"ok");
}
function loadTask(){
  if(!S.tasks.length){ alert("No tasks in vault. Create one."); return;}
  const list = S.tasks.map((t,i)=> `${i+1}. ${t.trn} (${(t.tags||[]).join('/')})`).join("\\n");
  const n = prompt("Select task:\\n"+list, "1"); const idx = (Number(n)||1)-1;
  const t = S.tasks[idx]; if(!t) return;
  S.trn = t.trn; S.fb.target = {label: t.cue || "Tasked Target", tags: t.tags||[]}; // целта за feedback
  updateTop(); log("[TASK] loaded TRN "+t.trn,"ok");
}
function saveTask(){
  if(!S.fb.target){ alert("No current target context to save."); return; }
  const t = { trn:S.trn, cue:S.fb.target.label, tags:S.fb.target.tags||[] };
  S.tasks.push(t); localStorage.setItem('airv_tasks', JSON.stringify(S.tasks));
  log("[TASK] saved to vault","ok");
}

</script>
</body>
</html>
